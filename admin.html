<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Panel - Student Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        transition: transform 0.2s ease;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .admin-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
</style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
        <i class="fas fa-graduation-cap me-2"></i>Student Portal
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
            <a class="nav-link" href="add-student.html">
                <i class="fas fa-user-plus me-1"></i>Add Student
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="courses.html">
                <i class="fas fa-book me-1"></i>Courses
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="report.html">
                <i class="fas fa-chart-bar me-1"></i>Reports
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="admin.html">
                <i class="fas fa-cogs me-1"></i>Admin
            </a>
        </li>
      </ul>
      <span id="who" class="text-white me-3">
        <i class="fas fa-user me-1"></i>
        <span id="userEmail"></span>
      </span>
      <button id="signOutBtn" class="btn btn-outline-light btn-sm">
        <i class="fas fa-sign-out-alt me-1"></i>Sign Out
      </button>
    </div>
  </div>
</nav>

<div class="container py-4">
    <!-- Admin Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stats-card p-3 text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3 id="totalUsers">0</h3>
                <p class="mb-0">Total Users</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card p-3 text-center">
                <i class="fas fa-user-graduate fa-2x mb-2"></i>
                <h3 id="totalStudents">0</h3>
                <p class="mb-0">Total Students</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card p-3 text-center">
                <i class="fas fa-book fa-2x mb-2"></i>
                <h3 id="totalCourses">0</h3>
                <p class="mb-0">Total Courses</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card p-3 text-center">
                <i class="fas fa-building fa-2x mb-2"></i>
                <h3 id="totalCampuses">2</h3>
                <p class="mb-0">Campuses</p>
            </div>
        </div>
    </div>

    <!-- User Management -->
    <div class="card admin-card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>User Management</h5>
            <div class="d-flex gap-2">
                <input type="text" id="searchUsers" class="form-control form-control-sm" placeholder="Search users...">
                <select id="filterRole" class="form-select form-select-sm w-auto">
                    <option value="">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="staff">Staff</option>
                    <option value="campus_manager">Campus Manager</option>
                    <option value="student">Student</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Campus</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTbody">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading users...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="app-common.js"></script>
<script>
document.getElementById('signOutBtn').onclick = signOutAndGoLogin;

let allUsers = [];

(async ()=>{
    const user = await requireAuth(); 
    if(!user) return;
    
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('who').textContent = user.email + ' (' + (user.profile?.role||'user') + ')';
    
    if(user.profile?.role !== 'admin'){
        document.querySelector('.container').innerHTML = `
            <div class="alert alert-danger text-center mt-5">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h4>Access Denied</h4>
                <p>You are not authorized to access the admin panel.</p>
                <a href="add-student.html" class="btn btn-primary">Go to Dashboard</a>
            </div>
        `;
        return;
    }

    await loadAdminData();
    setupEventListeners();
})();

function setupEventListeners() {
    document.getElementById('searchUsers').addEventListener('input', filterUsers);
    document.getElementById('filterRole').addEventListener('change', filterUsers);
}

async function loadAdminData() {
    await Promise.all([
        loadUsers(),
        loadStatistics()
    ]);
}

async function loadUsers() {
    const tbody = document.getElementById('usersTbody');
    
    try {
        const snap = await db.collection('users').orderBy('createdAt','desc').get();
        allUsers = [];
        
        snap.forEach(doc => { 
            const u = doc.data();
            allUsers.push({
                id: doc.id,
                ...u
            });
        });
        
        renderUsers(allUsers);
    } catch(e) { 
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading users: ${e.message}
                </td>
            </tr>
        `;
    }
}

function renderUsers(users) {
    const tbody = document.getElementById('usersTbody');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    <i class="fas fa-users fa-2x mb-3"></i>
                    <p>No users found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const joinDate = user.createdAt ? 
            new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A';
            
        const roleBadge = user.role === 'admin' ? 'badge bg-danger' :
                         user.role === 'campus_manager' ? 'badge bg-warning' :
                         user.role === 'staff' ? 'badge bg-info' : 'badge bg-secondary';
        
        tbody.innerHTML += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <div class="fw-bold">${esc(user.name)}</div>
                        </div>
                    </div>
                </td>
                <td>${esc(user.email)}</td>
                <td><span class="${roleBadge}">${esc(user.role)}</span></td>
                <td>${esc(user.campusId||'N/A')}</td>
                <td><small class="text-muted">${joinDate}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
}

async function loadStatistics() {
    try {
        const usersSnap = await db.collection('users').get();
        document.getElementById('totalUsers').textContent = usersSnap.size;
        
        const studentsSnap = await db.collection('students').get();
        document.getElementById('totalStudents').textContent = studentsSnap.size;
        
        const coursesSnap = await db.collection('courses').get();
        document.getElementById('totalCourses').textContent = coursesSnap.size;
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

function filterUsers() {
    const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
    const roleFilter = document.getElementById('filterRole').value;
    
    let filtered = allUsers;
    
    if (searchTerm) {
        filtered = filtered.filter(user => 
            user.name.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm)
        );
    }
    
    if (roleFilter) {
        filtered = filtered.filter(user => user.role === roleFilter);
    }
    
    renderUsers(filtered);
}

window.editUser = async (userId) => {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    const newRole = prompt('Enter new role (admin/staff/campus_manager/student):', user.role);
    if (!newRole || !['admin', 'staff', 'campus_manager', 'student'].includes(newRole)) {
        alert('Invalid role');
        return;
    }
    
    try {
        await db.collection('users').doc(userId).update({
            role: newRole,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('User role updated successfully');
        await loadUsers();
    } catch (error) {
        alert('Error updating user: ' + error.message);
    }
};

window.deleteUser = async (userId) => {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    if (!confirm(`Are you sure you want to delete user "${user.name}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        await db.collection('users').doc(userId).delete();
        alert('User deleted successfully');
        await loadUsers();
        await loadStatistics();
    } catch (error) {
        alert('Error deleting user: ' + error.message);
    }
};
</script>
</body>
</html>