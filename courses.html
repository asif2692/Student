<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Course Management - Student Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .course-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        border-radius: 12px;
    }
    .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .status-badge {
        font-size: 0.75em;
    }
    .course-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
    }
    .sample-courses {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
</style>
</head>
<body class="bg-light">

<!-- ✅ Enhanced Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="fas fa-graduation-cap me-2"></i>Student Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="topNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="add-student.html">
                        <i class="fas fa-user-plus me-1"></i>Add Student
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="courses.html">
                        <i class="fas fa-book me-1"></i>Courses
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="report.html">
                        <i class="fas fa-chart-bar me-1"></i>Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="admin.html">
                        <i class="fas fa-cogs me-1"></i>Admin
                    </a>
                </li>
            </ul>
            <span id="who" class="text-white me-3">
                <i class="fas fa-user me-1"></i>
                <span id="userEmail"></span>
            </span>
            <button id="signOutBtn" class="btn btn-outline-light btn-sm">
                <i class="fas fa-sign-out-alt me-1"></i>Sign Out
            </button>
        </div>
    </div>
</nav>

<div class="container py-4">
    <!-- ✅ Sample Courses Section (Show if no courses exist) -->
    <div id="sampleCoursesSection" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card sample-courses shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-rocket fa-2x mb-3"></i>
                    <h4>Get Started with Sample Courses</h4>
                    <p class="mb-3">It looks like you don't have any courses yet. Add sample courses to get started quickly!</p>
                    <button id="addSampleCoursesBtn" class="btn btn-light">
                        <i class="fas fa-plus me-1"></i>Add Sample Courses
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stats-card p-3 text-center">
                <i class="fas fa-book fa-2x mb-2"></i>
                <h4 id="totalCourses">0</h4>
                <p class="mb-0">Total Courses</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card p-3 text-center">
                <i class="fas fa-play-circle fa-2x mb-2"></i>
                <h4 id="activeCourses">0</h4>
                <p class="mb-0">Active Courses</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card p-3 text-center">
                <i class="fas fa-pause-circle fa-2x mb-2"></i>
                <h4 id="inactiveCourses">0</h4>
                <p class="mb-0">Inactive Courses</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card course-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-plus-circle fa-2x text-primary mb-2"></i>
                    <h5>Add New</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                        Create Course
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ Courses Grid -->
    <div class="row" id="coursesGrid">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Courses</h5>
                    <div class="d-flex gap-2">
                        <input type="text" id="searchCourse" class="form-control form-control-sm" placeholder="Search courses...">
                        <select id="filterStatus" class="form-select form-select-sm w-auto">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingCourses" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading courses...</p>
                    </div>
                    <div id="coursesContainer" class="row" style="display: none;"></div>
                    <div id="noCourses" class="text-center py-4" style="display: none;">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <h5>No Courses Found</h5>
                        <p class="text-muted">Get started by creating your first course.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                            <i class="fas fa-plus me-1"></i>Add First Course
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add New Course</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Course Name *</label>
                            <input type="text" id="courseName" class="form-control" placeholder="e.g., Web Development" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Course Code *</label>
                            <input type="text" id="courseCode" class="form-control" placeholder="e.g., WD-101" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Duration (months) *</label>
                            <input type="number" id="courseDuration" class="form-control" placeholder="6" min="1" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fee (PKR) *</label>
                            <input type="number" id="courseFee" class="form-control" placeholder="15000" min="0" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select id="courseStatus" class="form-select">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea id="courseDescription" class="form-control" rows="3" placeholder="Course description..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveCourseBtn" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Save Course
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="app-common.js"></script>
<script>
document.getElementById('signOutBtn').onclick = signOutAndGoLogin;

let allCourses = [];
let currentEditingId = null;

(async () => {
    const user = await requireAuth();
    if (!user) return;
    
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('who').textContent = user.email + " (" + (user.profile?.role || 'user') + ")";
    
    // Only admin can manage courses
    if (user.profile?.role !== 'admin') {
        document.getElementById('coursesGrid').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h4>Access Denied</h4>
                    <p>Only administrators can manage courses.</p>
                    <a href="add-student.html" class="btn btn-primary">Go to Students</a>
                </div>
            </div>
        `;
        return;
    }

    await loadCourses();
    setupEventListeners();
})();

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchCourse').addEventListener('input', filterCourses);
    document.getElementById('filterStatus').addEventListener('change', filterCourses);
    
    // Save course
    document.getElementById('saveCourseBtn').onclick = saveCourse;
    
    // Add sample courses
    document.getElementById('addSampleCoursesBtn').onclick = addSampleCourses;
    
    // Reset form when modal closes
    document.getElementById('addCourseModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('courseForm').reset();
        currentEditingId = null;
        document.querySelector('.modal-title').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add New Course';
    });
}

async function loadCourses() {
    const loadingEl = document.getElementById('loadingCourses');
    const containerEl = document.getElementById('coursesContainer');
    const noCoursesEl = document.getElementById('noCourses');
    const sampleSection = document.getElementById('sampleCoursesSection');
    
    try {
        const snapshot = await db.collection('courses').orderBy('createdAt', 'desc').get();
        allCourses = [];
        
        snapshot.forEach(doc => {
            allCourses.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        updateStatistics();
        renderCourses(allCourses);
        
        loadingEl.style.display = 'none';
        
        if (allCourses.length === 0) {
            noCoursesEl.style.display = 'block';
            containerEl.style.display = 'none';
            sampleSection.style.display = 'block';
        } else {
            noCoursesEl.style.display = 'none';
            containerEl.style.display = 'block';
            sampleSection.style.display = 'none';
        }
    } catch (error) {
        loadingEl.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading courses: ${error.message}
            </div>
        `;
    }
}

// Add sample courses function
async function addSampleCourses() {
    const sampleCourses = [
        {
            name: "Web Development",
            code: "WD-101",
            duration: 6,
            fee: 15000,
            status: "active",
            description: "Complete web development course covering HTML, CSS, JavaScript, and modern frameworks."
        },
        {
            name: "Mobile App Development",
            code: "MAD-102",
            duration: 6,
            fee: 18000,
            status: "active",
            description: "Learn to build mobile applications for iOS and Android using React Native."
        },
        {
            name: "Graphic Design",
            code: "GD-103",
            duration: 4,
            fee: 12000,
            status: "active",
            description: "Master graphic design principles and tools like Adobe Photoshop and Illustrator."
        },
        {
            name: "Digital Marketing",
            code: "DM-104",
            duration: 3,
            fee: 10000,
            status: "active",
            description: "Learn digital marketing strategies including SEO, social media, and email marketing."
        }
    ];

    const btn = document.getElementById('addSampleCoursesBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding Courses...';
    btn.disabled = true;

    try {
        for (const course of sampleCourses) {
            await db.collection('courses').add({
                ...course,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        alert('Sample courses added successfully!');
        await loadCourses();
    } catch (error) {
        alert('Error adding sample courses: ' + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function updateStatistics() {
    const total = allCourses.length;
    const active = allCourses.filter(c => c.status === 'active').length;
    const inactive = allCourses.filter(c => c.status === 'inactive').length;
    
    document.getElementById('totalCourses').textContent = total;
    document.getElementById('activeCourses').textContent = active;
    document.getElementById('inactiveCourses').textContent = inactive;
}

function renderCourses(courses) {
    const container = document.getElementById('coursesContainer');
    container.innerHTML = '';
    
    if (courses.length === 0) {
        document.getElementById('noCourses').style.display = 'block';
        container.style.display = 'none';
        return;
    }
    
    courses.forEach(course => {
        const courseCard = `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card course-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="course-icon text-white">
                                <i class="fas fa-book"></i>
                            </div>
                            <span class="badge ${course.status === 'active' ? 'bg-success' : 'bg-secondary'} status-badge">
                                ${course.status}
                            </span>
                        </div>
                        <h5 class="card-title">${esc(course.name)}</h5>
                        <p class="text-muted small">${esc(course.code)}</p>
                        <p class="card-text">${esc(course.description || 'No description available.')}</p>
                        
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <small class="text-muted">Duration</small>
                                <div class="fw-bold">${esc(course.duration)} months</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Fee</small>
                                <div class="fw-bold">PKR ${esc(course.fee)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-primary btn-sm" onclick="editCourse('${course.id}')">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCourse('${course.id}')">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += courseCard;
    });
}

function filterCourses() {
    const searchTerm = document.getElementById('searchCourse').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    
    let filtered = allCourses;
    
    if (searchTerm) {
        filtered = filtered.filter(course => 
            course.name.toLowerCase().includes(searchTerm) ||
            course.code.toLowerCase().includes(searchTerm) ||
            course.description.toLowerCase().includes(searchTerm)
        );
    }
    
    if (statusFilter) {
        filtered = filtered.filter(course => course.status === statusFilter);
    }
    
    renderCourses(filtered);
}

async function saveCourse() {
    const name = document.getElementById('courseName').value.trim();
    const code = document.getElementById('courseCode').value.trim();
    const duration = document.getElementById('courseDuration').value.trim();
    const fee = document.getElementById('courseFee').value.trim();
    const status = document.getElementById('courseStatus').value;
    const description = document.getElementById('courseDescription').value.trim();
    
    if (!name || !code || !duration || !fee) {
        alert('Please fill all required fields');
        return;
    }
    
    const saveBtn = document.getElementById('saveCourseBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    saveBtn.disabled = true;
    
    try {
        const courseData = {
            name,
            code,
            duration: parseInt(duration),
            fee: parseInt(fee),
            status,
            description,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (currentEditingId) {
            // Update existing course
            await db.collection('courses').doc(currentEditingId).update(courseData);
        } else {
            // Add new course
            courseData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('courses').add(courseData);
        }
        
        // Close modal and refresh
        bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();
        await loadCourses();
        
    } catch (error) {
        alert('Error saving course: ' + error.message);
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

window.editCourse = async (courseId) => {
    const course = allCourses.find(c => c.id === courseId);
    if (!course) return;
    
    currentEditingId = courseId;
    
    // Fill form with course data
    document.getElementById('courseName').value = course.name;
    document.getElementById('courseCode').value = course.code;
    document.getElementById('courseDuration').value = course.duration;
    document.getElementById('courseFee').value = course.fee;
    document.getElementById('courseStatus').value = course.status;
    document.getElementById('courseDescription').value = course.description || '';
    
    // Update modal title
    document.querySelector('.modal-title').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Course';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('addCourseModal')).show();
};

window.deleteCourse = async (courseId) => {
    if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        return;
    }
    
    try {
        await db.collection('courses').doc(courseId).delete();
        await loadCourses();
    } catch (error) {
        alert('Error deleting course: ' + error.message);
    }
};
</script>
</body>
</html>